---
import { countries, emailDomains } from '../lib/data';
---

<div class="max-w-2xl mx-auto px-4 py-8">
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-8 text-white">
      <h1 class="text-3xl font-bold mb-2">Facebook 注册信息生成器</h1>
      <p class="text-blue-100">自动生成随机注册信息,保护您的隐私</p>
    </div>

    <div class="p-6">
      <div id="loading-state" class="text-center py-12">
        <div class="inline-block w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">正在检测您的位置...</p>
      </div>

      <div id="generator-content" class="hidden">
        <div class="space-y-4 mb-6">
          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">姓氏</label>
            <div class="flex gap-2">
              <input type="text" id="lastName" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button data-copy="lastName" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>

          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">名字</label>
            <div class="flex gap-2">
              <input type="text" id="firstName" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button data-copy="firstName" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>

          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">生日</label>
            <div class="flex gap-2">
              <input type="text" id="birthday" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button data-copy="birthday" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>

          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              手机号
              <span id="phonePrefix" class="text-gray-500 text-xs ml-2"></span>
            </label>
            <div class="flex gap-2">
              <input type="text" id="phone" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button data-copy="phone" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>

          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
            <div class="flex gap-2">
              <input type="text" id="password" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono" />
              <button data-copy="password" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>

          <div class="field-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
            <div class="flex gap-2">
              <input type="text" id="email" readonly class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button data-copy="email" class="copy-btn px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors min-w-[80px]">复制</button>
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="regenerateBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all font-medium shadow-md hover:shadow-lg">
            生成新身份
          </button>
          <button id="inboxBtn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium shadow-md hover:shadow-lg">
            查看收件箱
          </button>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200 flex gap-3">
          <button id="countryBtn" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-between">
            <span>地区:</span>
            <span id="selectedCountry" class="font-medium text-blue-600"></span>
          </button>
          <button id="domainBtn" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-between">
            <span>邮箱域名:</span>
            <span id="selectedDomain" class="font-medium text-blue-600">随机</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="countryDrawer" class="drawer">
  <div class="drawer-backdrop"></div>
  <div class="drawer-panel">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">选择地区</h3>
      <button class="drawer-close text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
    </div>
    <div class="space-y-2 max-h-96 overflow-y-auto">
      {countries.map(country => (
        <button
          data-country={country.code}
          class="country-option w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between"
        >
          <span class="font-medium">{country.name}</span>
          <span class="text-sm text-gray-500">{country.phonePrefix}</span>
        </button>
      ))}
    </div>
  </div>
</div>

<div id="domainDrawer" class="drawer">
  <div class="drawer-backdrop"></div>
  <div class="drawer-panel">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">选择邮箱域名</h3>
      <button class="drawer-close text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
    </div>
    <input
      type="text"
      id="domainSearch"
      placeholder="搜索域名..."
      class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <div id="domainList" class="space-y-2 max-h-80 overflow-y-auto">
      {emailDomains.map(domain => (
        <button
          data-domain={domain.value}
          class="domain-option w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors"
        >
          {domain.label}
        </button>
      ))}
    </div>
  </div>
</div>

<style>
  .drawer {
    @apply fixed inset-0 z-50 hidden;
  }

  .drawer.active {
    @apply flex items-end justify-center;
  }

  .drawer-backdrop {
    @apply absolute inset-0 bg-black bg-opacity-50 transition-opacity;
  }

  .drawer-panel {
    @apply relative bg-white w-full max-w-2xl rounded-t-2xl p-6 shadow-xl transform transition-transform;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(100%);
    }
    to {
      transform: translateY(0);
    }
  }

  @media (min-width: 768px) {
    .drawer {
      @apply items-center;
    }

    .drawer-panel {
      @apply rounded-2xl max-h-[80vh];
    }
  }
</style>

<script>
  import { detectCountry } from '../lib/ipDetector';
  import { generateInfo } from '../lib/generator';
  import { countries, emailDomains } from '../lib/data';
  import type { GeneratedInfo } from '../lib/types';

  let currentCountry = 'US';
  let currentDomain = 'random';
  let currentInfo: GeneratedInfo;

  const $ = <T extends HTMLElement>(selector: string): T | null => document.querySelector(selector);
  const $$ = <T extends HTMLElement>(selector: string): NodeListOf<T> => document.querySelectorAll(selector);

  const updateUI = (info: GeneratedInfo) => {
    currentInfo = info;
    ($('#lastName') as HTMLInputElement).value = info.lastName;
    ($('#firstName') as HTMLInputElement).value = info.firstName;
    ($('#birthday') as HTMLInputElement).value = info.birthday;
    ($('#phone') as HTMLInputElement).value = info.phone;
    ($('#password') as HTMLInputElement).value = info.password;
    ($('#email') as HTMLInputElement).value = info.email;

    const country = countries.find(c => c.code === currentCountry);
    if (country) {
      ($('#selectedCountry') as HTMLElement).textContent = country.name;
      ($('#phonePrefix') as HTMLElement).textContent = country.phonePrefix;
    }
  };

  const copyToClipboard = async (text: string, button: HTMLElement) => {
    try {
      await navigator.clipboard.writeText(text);
      const originalText = button.textContent;
      button.textContent = '已复制';
      button.classList.add('bg-green-500', 'hover:bg-green-600');
      button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-500', 'hover:bg-green-600');
        button.classList.add('bg-blue-500', 'hover:bg-blue-600');
      }, 1500);
    } catch (err) {
      console.error('Copy failed:', err);
    }
  };

  const openDrawer = (drawerId: string) => {
    const drawer = $(`#${drawerId}`);
    if (drawer) {
      drawer.classList.add('active');
    }
  };

  const closeDrawer = (drawerId: string) => {
    const drawer = $(`#${drawerId}`);
    if (drawer) {
      drawer.classList.remove('active');
    }
  };

  const init = async () => {
    const detectedCountry = await detectCountry();
    currentCountry = countries.find(c => c.code === detectedCountry) ? detectedCountry : 'US';

    const loadingState = $('#loading-state');
    const generatorContent = $('#generator-content');

    if (loadingState && generatorContent) {
      loadingState.classList.add('hidden');
      generatorContent.classList.remove('hidden');
    }

    const info = generateInfo(currentCountry, currentDomain);
    updateUI(info);
  };

  document.addEventListener('DOMContentLoaded', () => {
    init();

    $('#regenerateBtn')?.addEventListener('click', () => {
      const info = generateInfo(currentCountry, currentDomain);
      updateUI(info);
    });

    $('#inboxBtn')?.addEventListener('click', () => {
      const username = currentInfo.email.split('@')[0];
      window.open(`https://yopmail.net/?login=${username}`, '_blank');
    });

    $('#countryBtn')?.addEventListener('click', () => openDrawer('countryDrawer'));
    $('#domainBtn')?.addEventListener('click', () => openDrawer('domainDrawer'));

    $$('.drawer-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        const drawer = (e.target as HTMLElement).closest('.drawer');
        if (drawer) {
          drawer.classList.remove('active');
        }
      });
    });

    $$('.drawer-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', (e) => {
        const drawer = (e.target as HTMLElement).closest('.drawer');
        if (drawer) {
          drawer.classList.remove('active');
        }
      });
    });

    $$('.country-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const code = (e.currentTarget as HTMLElement).dataset.country;
        if (code) {
          currentCountry = code;
          closeDrawer('countryDrawer');
          const info = generateInfo(currentCountry, currentDomain);
          updateUI(info);
        }
      });
    });

    $$('.domain-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const domain = (e.currentTarget as HTMLElement).dataset.domain;
        if (domain) {
          currentDomain = domain;
          const domainLabel = emailDomains.find(d => d.value === domain)?.label || '随机';
          ($('#selectedDomain') as HTMLElement).textContent = domainLabel;
          closeDrawer('domainDrawer');
          const info = generateInfo(currentCountry, currentDomain);
          updateUI(info);
        }
      });
    });

    $('#domainSearch')?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      $$('.domain-option').forEach(option => {
        const text = option.textContent?.toLowerCase() || '';
        if (text.includes(query)) {
          option.classList.remove('hidden');
        } else {
          option.classList.add('hidden');
        }
      });
    });

    $$('.copy-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const fieldId = (e.currentTarget as HTMLElement).dataset.copy;
        if (fieldId) {
          const input = $(`#${fieldId}`) as HTMLInputElement;
          if (input) {
            copyToClipboard(input.value, e.currentTarget as HTMLElement);
          }
        }
      });
    });
  });
</script>
